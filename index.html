<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NUM‚óèDUEL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#06080f;--s1:#0f1320;--s2:#161c2e;--s3:#1e2640;
  --bdr:#263354;--acc:#f59e0b;--acc2:#b45309;
  --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
  --tx:#e8ecf4;--tx2:#5e6e8a;
  --p1:#818cf8;--p2:#f472b6;
}
body{background:var(--bg);color:var(--tx);font-family:'DM Sans',system-ui,sans-serif;min-height:100dvh;overflow-x:hidden}
.mono{font-family:'JetBrains Mono',monospace}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes pop{0%{transform:scale(.85);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes glow{0%,100%{box-shadow:0 0 6px var(--p2)}50%{box-shadow:0 0 20px var(--p2)}}
.fade-up{animation:fadeUp .35s ease both}
.pop{animation:pop .3s ease both}

.screen{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 16px}
.card{background:var(--s1);border:1px solid var(--bdr);border-radius:20px;padding:28px 24px;width:100%;max-width:440px}

.inp{width:100%;padding:14px 16px;font-size:16px;background:var(--s2);border:1.5px solid var(--bdr);border-radius:12px;color:var(--tx);outline:none;font-family:inherit;transition:border .2s}
.inp:focus{border-color:var(--acc)}
.inp::placeholder{color:var(--tx2)}
.dig-inp{font-family:'JetBrains Mono',monospace;font-size:28px;letter-spacing:14px;text-align:center;padding:16px 20px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:12px;border:none;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .12s;width:100%}
.btn:active{transform:scale(.97)}.btn:disabled{opacity:.35;cursor:default;transform:none}
.btn-go{background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff}
.btn-acc{background:var(--acc);color:#000}
.btn-out{background:0 0;border:2px solid var(--bdr);color:var(--tx2)}
.btn-out:hover{border-color:var(--acc);color:var(--acc)}
.btn-sm{padding:9px 14px;font-size:13px;width:auto;border-radius:10px}
.btn-ok{background:#10b98118;border:1.5px solid var(--ok);color:var(--ok)}
.btn-bad{background:#ef444418;border:1.5px solid var(--bad);color:var(--bad)}

.chips{display:flex;gap:8px}
.chip{flex:1;padding:14px 0;border-radius:12px;font-size:20px;font-weight:800;border:2px solid var(--bdr);background:0 0;color:var(--tx2);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace}
.chip.on{border-color:var(--acc);background:#b4530920;color:var(--acc)}

.code{font-family:'JetBrains Mono',monospace;font-size:38px;font-weight:800;letter-spacing:10px;color:var(--acc);text-align:center;padding:18px;background:#b4530920;border:2px dashed #f59e0b44;border-radius:16px;cursor:pointer;user-select:all;transition:all .2s}
.code:active{transform:scale(.97)}

.topbar{background:var(--s1);border-bottom:1px solid var(--bdr);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.my-secret{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:800;letter-spacing:8px;color:var(--acc)}
.my-secret-lbl{font-size:10px;color:var(--tx2);text-transform:uppercase;letter-spacing:1px;font-weight:700}

.status{padding:10px 16px;text-align:center;font-size:14px;font-weight:700;position:sticky;top:57px;z-index:99}
.status.go{background:#818cf822;border-bottom:2px solid var(--p1);color:var(--p1)}
.status.wait{background:var(--s2);border-bottom:1px solid var(--bdr);color:var(--tx2)}
.status.fb{background:#f472b622;border-bottom:2px solid var(--p2);color:var(--p2);animation:glow 2s ease infinite}
.status.done{background:#10b98122;border-bottom:2px solid var(--ok);color:var(--ok)}

.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--bdr)}
.tab{flex:1;padding:12px;text-align:center;font-size:13px;font-weight:700;cursor:pointer;border:none;background:0 0;color:var(--tx2);border-bottom:3px solid transparent;transition:all .12s;font-family:inherit;position:relative}
.tab.on{color:var(--p1);border-bottom-color:var(--p1)}
.tab.on:last-child{color:var(--p2);border-bottom-color:var(--p2)}
.tab .dot{position:absolute;top:8px;right:calc(50% - 40px);width:8px;height:8px;border-radius:50%;background:var(--bad);animation:pulse 1s ease infinite}

.glist{padding:8px 16px;flex:1;overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none}
.glist::-webkit-scrollbar{display:none}
.grow{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;margin-bottom:4px;animation:fadeUp .25s ease both}
.grow:nth-child(even){background:#161c2e66}
.gnum{color:var(--tx2);font-size:11px;font-weight:700;width:22px;flex-shrink:0}
.gdigs{display:flex;gap:4px;flex-shrink:0}
.gdig{width:34px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--s3);border:1.5px solid var(--bdr);border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700}
.gfb{display:flex;gap:5px;margin-left:auto;flex-wrap:wrap;justify-content:flex-end}
.badge{padding:3px 9px;border-radius:20px;font-size:12px;font-weight:700;white-space:nowrap}
.b-ok{background:#10b98118;color:var(--ok)}.b-w{background:#f59e0b18;color:var(--warn)}.b-no{background:#ef444418;color:var(--bad)}
.b-win{background:var(--ok);color:#000;font-weight:800;padding:4px 14px}
.b-wait{color:var(--tx2);font-size:12px;font-style:italic}

.fbp{background:var(--s2);border-radius:16px;padding:16px;border:1.5px solid #f472b644;margin:12px 0;animation:fadeUp .3s ease both}
.fbguess{font-family:'JetBrains Mono',monospace;font-size:28px;letter-spacing:10px;text-align:center;color:var(--tx);font-weight:800;margin-bottom:14px}
.fbrow{display:flex;align-items:center;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.fblbl{font-size:12px;font-weight:700;min-width:95px;flex-shrink:0}
.fbn{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .1s;border:1.5px solid var(--bdr);background:0 0;color:var(--tx2)}
.fbn.on{border-color:var(--acc);background:#b4530920;color:var(--acc);transform:scale(1.1)}
.fbacts{display:flex;gap:8px;margin-top:12px}
.fbacts .btn{flex:1}

.actbar{position:sticky;bottom:0;background:var(--s1);border-top:1px solid var(--bdr);padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom));z-index:100}
.ginrow{display:flex;gap:8px;align-items:center}
.ginrow .dig-inp{font-size:22px;letter-spacing:10px;padding:12px 16px}
.ginrow .btn{width:auto;flex-shrink:0;padding:14px 20px}

.rev-box{text-align:center;padding:14px 20px;background:#b4530920;border:2px solid var(--acc);border-radius:12px;margin:16px 0}
.rev-lbl{font-size:10px;color:var(--tx2);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:4px}

.label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx2);margin-bottom:8px}
.divider{display:flex;align-items:center;gap:12px;color:var(--tx2);font-size:12px;margin:18px 0;font-weight:600}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bdr)}
.error{color:var(--bad);font-size:13px;text-align:center;margin-top:8px}
.pdot{width:10px;height:10px;border-radius:50%;background:var(--acc);animation:pulse 1.4s ease-in-out infinite;margin:0 auto}

.overlay{position:fixed;inset:0;background:rgba(6,8,15,.92);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeUp .3s ease}
.wcard{text-align:center;padding:40px 32px;max-width:360px;width:100%}

.glayout{display:flex;flex-direction:column;min-height:100dvh}

.copied-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--ok);color:#000;padding:8px 20px;border-radius:10px;font-size:14px;font-weight:700;z-index:999;animation:fadeUp .3s ease both}

.conn-status{position:fixed;bottom:8px;right:8px;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;z-index:300;pointer-events:none}
.conn-ok{background:#10b98133;color:var(--ok)}
.conn-err{background:#ef444433;color:var(--bad)}

@media(max-width:400px){
  .gdig{width:28px;height:32px;font-size:15px}
  .dig-inp{font-size:22px;letter-spacing:10px}
  .my-secret{font-size:20px;letter-spacing:6px}
  .badge{font-size:11px;padding:2px 7px}
  .card{padding:22px 18px}
  .code{font-size:30px;letter-spacing:8px}
}
</style>
</head>
<body>
<div id="app"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyDxwgjrwYFWt9alVan9SggLMb64d_SCUms",
  authDomain: "praizandzikky.firebaseapp.com",
  databaseURL: "https://praizandzikky-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "praizandzikky",
  storageBucket: "praizandzikky.firebasestorage.app",
  messagingSenderId: "865597201878",
  appId: "1:865597201878:web:a8ddca393afe6867141877",
  measurementId: "G-XQ223KRGCY"
};

let db, fbOk = false, unsub = null;
try {
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  fbOk = true;
  console.log('‚úÖ Firebase connected');
} catch(e) {
  console.error('Firebase init failed:', e);
}

// ‚îÄ‚îÄ DB Layer ‚îÄ‚îÄ
const DB = {
  async write(id, data) {
    if (!fbOk) throw new Error('Firebase not connected');
    await set(ref(db, 'games/' + id), data);
  },
  async read(id) {
    if (!fbOk) throw new Error('Firebase not connected');
    const s = await get(ref(db, 'games/' + id));
    return s.exists() ? s.val() : null;
  },
  listen(id, cb) {
    this.stop();
    if (!fbOk) return;
    unsub = onValue(ref(db, 'games/' + id), s => { if(s.exists()) cb(s.val()); });
  },
  stop() { if(unsub){unsub();unsub=null;} }
};

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let S = {
  scr:'home', gid:'', join:'', name:localStorage.getItem('nd_name')||'',
  role:0, digits:4, secret:'', guess:'', tab:'my',
  revealed:false, opRev:false, fbP:0, fbN:0,
  err:'', G:null, showWin:false, loading:false
};

let renderQueued = false;
const TYPING_KEYS = ['name','join','secret','guess'];
function up(o) {
  Object.assign(S, o);
  if (o.name !== undefined) localStorage.setItem('nd_name', S.name);
  // Skip full re-render when only typing in inputs ‚Äî prevents focus loss
  const onlyTyping = Object.keys(o).every(k => TYPING_KEYS.includes(k));
  if (onlyTyping && Object.keys(o).length > 0) return;
  if (!renderQueued) {
    renderQueued = true;
    requestAnimationFrame(() => { renderQueued = false; render(); });
  }
}

const me = () => S.G ? (S.role===1 ? S.G.player1 : S.G.player2) : null;
const opp = () => S.G ? (S.role===1 ? S.G.player2 : S.G.player1) : null;

// ‚îÄ‚îÄ Game Actions ‚îÄ‚îÄ
function getHomeInputs() {
  const nameEl = document.getElementById('name-inp');
  const joinEl = document.getElementById('join-inp');
  return { name: (nameEl?.value ?? '').trim(), join: (joinEl?.value ?? '').trim().toUpperCase() };
}
async function create() {
  const { name } = getHomeInputs();
  if (!name) { up({err:'Enter your name!'}); return; }
  if (!fbOk) { up({err:'Firebase not connected. Check config.'}); return; }
  up({loading:true, err:'', name});
  try {
    const id = Math.random().toString(36).substring(2,8).toUpperCase();
    const G = {
      digits: S.digits,
      player1: { name, secret: '', guesses: false, revealed: false },
      player2: false,
      currentTurn: 1, status: 'waiting', winner: 0, ts: Date.now()
    };
    await DB.write(id, G);
    up({gid:id, role:1, G, scr:'waiting', loading:false});
    DB.listen(id, onGameUpdate);
  } catch(e) {
    up({err:'Failed to create game: '+e.message, loading:false});
  }
}

async function join() {
  const { name, join: joinCode } = getHomeInputs();
  if (!name) { up({err:'Enter your name!'}); return; }
  if (!joinCode) { up({err:'Enter game code!'}); return; }
  if (!fbOk) { up({err:'Firebase not connected. Check config.'}); return; }
  up({loading:true, err:'', name, join: joinCode});
  try {
    const id = joinCode;
    const G = await DB.read(id);
    if (!G) { up({err:'Game not found! Double-check the code.', loading:false}); return; }
    if (G.player2) { up({err:'Game is already full!', loading:false}); return; }
    G.player2 = { name, secret: '', guesses: false, revealed: false };
    G.status = 'setting_secrets';
    await DB.write(id, G);
    up({gid:id, role:2, digits:G.digits, G, scr:'set_secret', loading:false, err:''});
    DB.listen(id, onGameUpdate);
  } catch(e) {
    up({err:'Failed to join: '+e.message, loading:false});
  }
}

function onGameUpdate(G) {
  if (!G) return;
  const u = {G};
  // Screen transitions
  if (S.scr==='waiting' && G.player2) u.scr = 'set_secret';
  if (S.scr==='waiting_secret' && G.status==='playing') { u.scr='playing'; u.tab='my'; }
  // Check opponent needs feedback
  const o = S.role===1 ? G.player2 : G.player1;
  if (o && S.scr==='playing') {
    const gs = o.guesses ? Object.values(o.guesses) : [];
    const last = gs[gs.length-1];
    if (last && !last.feedback && S.tab !== 'their') u.tab = 'their';
  }
  if (o?.revealed) u.opRev = true;
  if (G.status==='finished' && !S.showWin) u.showWin = true;
  up(u);
}

async function lockSecret() {
  if (S.secret.length !== S.digits) { up({err:`Need ${S.digits} digits!`}); return; }
  up({loading:true, err:''});
  try {
    const G = await DB.read(S.gid);
    const k = S.role===1 ? 'player1' : 'player2';
    G[k].secret = S.secret;
    const otherKey = S.role===1 ? 'player2' : 'player1';
    if (G[otherKey] && G[otherKey].secret) G.status = 'playing';
    await DB.write(S.gid, G);
    up(G.status==='playing'
      ? {G, scr:'playing', tab:'my', loading:false, err:''}
      : {G, scr:'waiting_secret', loading:false, err:''});
  } catch(e) { up({err:'Error: '+e.message, loading:false}); }
}

async function sendGuess() {
  if (S.guess.length !== S.digits) { up({err:`Need ${S.digits} digits!`}); return; }
  up({loading:true, err:''});
  try {
    const G = await DB.read(S.gid);
    const k = S.role===1 ? 'player1' : 'player2';
    // Firebase doesn't support arrays well ‚Äî use object with numeric keys
    let guesses = G[k].guesses ? (typeof G[k].guesses === 'object' ? Object.values(G[k].guesses) : []) : [];
    guesses.push({ value: S.guess, feedback: false });
    G[k].guesses = guesses;
    G.currentTurn = S.role===1 ? 2 : 1;
    await DB.write(S.gid, G);
    up({G, guess:'', loading:false, err:''});
  } catch(e) { up({err:'Error: '+e.message, loading:false}); }
}

async function sendFb() {
  up({loading:true});
  try {
    const G = await DB.read(S.gid);
    const ok = S.role===1 ? 'player2' : 'player1';
    let guesses = G[ok].guesses ? Object.values(G[ok].guesses) : [];
    const last = guesses[guesses.length-1];
    if (last && !last.feedback) {
      last.feedback = { correctPos: S.fbP, correctNum: S.fbN };
      if (S.fbP === S.digits) { G.status='finished'; G.winner = S.role===1?2:1; }
      G.currentTurn = S.role;
    }
    G[ok].guesses = guesses;
    await DB.write(S.gid, G);
    up({G, fbP:0, fbN:0, tab:'my', loading:false, showWin:G.status==='finished'});
  } catch(e) { up({err:'Error: '+e.message, loading:false}); }
}

function allWrong() { S.fbP=0; S.fbN=0; sendFb(); }
function allCorrect() { S.fbP=S.digits; S.fbN=0; sendFb(); }

async function doReveal() {
  try {
    const G = await DB.read(S.gid);
    const k = S.role===1 ? 'player1' : 'player2';
    G[k].revealed = true;
    await DB.write(S.gid, G);
    up({G, revealed:true});
  } catch(e) { console.error(e); }
}

function restart() { DB.stop(); Object.assign(S,{scr:'home',gid:'',join:'',role:0,digits:4,secret:'',guess:'',tab:'my',revealed:false,opRev:false,fbP:0,fbN:0,err:'',G:null,showWin:false,loading:false}); render(); }

function toast(msg) {
  const t=document.createElement('div'); t.className='copied-toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),1500);
}

// ‚îÄ‚îÄ Helpers: get guesses as array (Firebase may return object) ‚îÄ‚îÄ
function getGuesses(player) {
  if (!player || !player.guesses) return [];
  if (Array.isArray(player.guesses)) return player.guesses;
  if (typeof player.guesses === 'object') return Object.values(player.guesses);
  return [];
}

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ
function h(tag,a,...ch){
  const el=document.createElement(tag);
  if(a)Object.entries(a).forEach(([k,v])=>{
    if(k==='style'&&typeof v==='object')Object.assign(el.style,v);
    else if(k.startsWith('on'))el.addEventListener(k.slice(2).toLowerCase(),v);
    else if(k==='className')el.className=v;
    else if((k==='value'||k==='defaultValue')&&(tag==='input'||tag==='textarea'))el.value=v??'';
    else if(k==='disabled'){if(v)el.setAttribute('disabled','');else el.removeAttribute('disabled');}
    else el.setAttribute(k,v);
  });
  ch.flat().forEach(c=>{if(c!=null)el.appendChild(typeof c==='string'?document.createTextNode(c):c);});
  return el;
}

function gRow(g,i){
  const ds=g.value.split(''), fb=g.feedback, fbs=[];
  if(fb && fb.correctPos !== undefined){
    if(fb.correctPos===ds.length) fbs.push(h('span',{className:'badge b-win'},'üéâ CRACKED!'));
    else{
      fbs.push(h('span',{className:'badge b-ok'},`‚úì ${fb.correctPos}`));
      fbs.push(h('span',{className:'badge b-w'},`~ ${fb.correctNum}`));
      fbs.push(h('span',{className:'badge b-no'},`‚úó ${ds.length-fb.correctPos-fb.correctNum}`));
    }
  } else fbs.push(h('span',{className:'b-wait'},'‚è≥ awaiting feedback'));
  return h('div',{className:'grow'},
    h('span',{className:'gnum'},`${i+1}`),
    h('div',{className:'gdigs'},...ds.map(d=>h('div',{className:'gdig'},d))),
    h('div',{className:'gfb'},...fbs));
}

function fbPanel(){
  const o=opp(); if(!o)return h('div');
  const gs=getGuesses(o), last=gs[gs.length-1];
  if(!last||last.feedback)return h('div');
  const nb=(max,cur,fn)=>Array.from({length:max+1},(_,i)=>
    h('button',{className:`fbn ${cur===i?'on':''}`,onClick:()=>{fn(i);render();}},`${i}`));
  return h('div',{className:'fbp'},
    h('div',{style:{fontSize:'13px',fontWeight:'700',color:'var(--p2)',marginBottom:'6px'}},`${o.name} guessed:`),
    h('div',{className:'fbguess'},last.value),
    h('div',{className:'fbrow'},
      h('span',{className:'fblbl',style:{color:'var(--ok)'}},'‚úì Right spot'),
      ...nb(S.digits,S.fbP,v=>{S.fbP=v;if(S.fbP+S.fbN>S.digits)S.fbN=S.digits-S.fbP;})),
    h('div',{className:'fbrow'},
      h('span',{className:'fblbl',style:{color:'var(--warn)'}},'~ Wrong spot'),
      ...nb(S.digits-S.fbP,S.fbN,v=>{S.fbN=v;})),
    h('div',{className:'fbacts'},
      h('button',{className:'btn btn-sm btn-bad',onClick:allWrong},'‚úó All Wrong'),
      h('button',{className:'btn btn-sm btn-ok',onClick:allCorrect},'‚òÖ All Correct'),
      h('button',{className:'btn btn-sm btn-acc',onClick:sendFb},'Submit ‚Üí')));
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function render(){
  const root=document.getElementById('app');
  root.innerHTML='';

  // Connection indicator
  const conn = h('div',{className:`conn-status ${fbOk?'conn-ok':'conn-err'}`},
    fbOk?'üü¢ Online':'üî¥ Offline');
  root.appendChild(conn);

  // HOME
  if(S.scr==='home'){
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'fade-up',style:{textAlign:'center',marginBottom:'32px'}},
        h('div',{style:{fontSize:'42px',fontWeight:'900',letterSpacing:'-2px'}},
          h('span',{style:{color:'var(--p1)'}},'NUM'),
          h('span',{style:{color:'var(--acc)'}},'‚óè'),
          h('span',{style:{color:'var(--p2)'}},'DUEL')),
        h('p',{style:{color:'var(--tx2)',fontSize:'15px',marginTop:'6px'}},'The number guessing showdown')),
      h('div',{className:'card fade-up'},
        h('div',{className:'label'},'Your Name'),
        h('input',{id:'name-inp',className:'inp',placeholder:'Enter your name',value:S.name}),
        h('div',{className:'label',style:{marginTop:'20px'}},'Number of Digits'),
        h('div',{className:'chips'},
          ...[3,4,5,6].map(n=>h('button',{className:`chip ${S.digits===n?'on':''}`,onClick:()=>{
            const {name,join}=getHomeInputs();
            up({digits:n,name,join});
          }},`${n}`))),
        h('button',{className:'btn btn-go',style:{marginTop:'20px'},disabled:S.loading,onClick:create},
          S.loading?'Creating...':'Create New Game'),
        h('div',{className:'divider'},'OR JOIN A GAME'),
        h('div',{style:{display:'flex',gap:'8px'}},
          h('input',{id:'join-inp',className:'inp mono',style:{letterSpacing:'6px',textAlign:'center',textTransform:'uppercase',fontSize:'18px'},
            placeholder:'GAME CODE',maxLength:'6',value:S.join,
            onKeydown:e=>{if(e.key==='Enter')join();}}),
          h('button',{className:'btn btn-out',style:{width:'auto',flexShrink:'0'},disabled:S.loading,onClick:join},
            S.loading?'...':'Join')),
        S.err?h('div',{className:'error'},S.err):null),
      h('div',{style:{marginTop:'24px',color:'var(--tx2)',fontSize:'13px',textAlign:'center',maxWidth:'380px',lineHeight:'1.6'}},
        h('strong',{style:{color:'var(--tx)'}},'How to play: '),
        'Each player picks a secret number. Take turns guessing each other\'s number. After each guess, give feedback: how many digits are correct + right position, correct but wrong position, or totally wrong. First to crack the code wins!')));
    return;
  }

  // WAITING
  if(S.scr==='waiting'){
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'card fade-up',style:{textAlign:'center'}},
        h('div',{className:'code',onClick:()=>{navigator.clipboard?.writeText(S.gid);toast('Code copied!');}},S.gid),
        h('p',{style:{color:'var(--tx2)',fontSize:'14px',marginTop:'14px'}},'Share this code with your partner'),
        h('p',{style:{color:'var(--tx2)',fontSize:'13px',marginTop:'4px'}},'Tap code to copy ‚Ä¢ Waiting for them to join...'),
        h('div',{style:{marginTop:'20px'}},h('div',{className:'pdot'})),
        h('p',{style:{fontSize:'12px',color:'var(--tx2)',marginTop:'16px'}},`${S.digits}-digit game ‚Ä¢ Game ID: ${S.gid}`))));
    return;
  }

  // SET SECRET
  if(S.scr==='set_secret'){
    const o=opp();
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'card fade-up',style:{textAlign:'center'}},
        h('div',{style:{fontSize:'36px',marginBottom:'8px'}},'üîê'),
        h('h2',{style:{fontSize:'22px',fontWeight:'800',marginBottom:'6px'}},'Set Your Secret'),
        h('p',{style:{color:'var(--tx2)',fontSize:'14px',marginBottom:'24px'}},
          `Pick a ${S.digits}-digit number for ${o?.name||'your opponent'} to guess`),
        h('input',{className:'inp dig-inp',type:'tel',maxLength:S.digits,placeholder:'‚Ä¢'.repeat(S.digits),value:S.secret,
          onInput:e=>{const v=e.target.value.replace(/[^0-9]/g,'');if(v.length<=S.digits)up({secret:v,err:''});},
          onKeydown:e=>{if(e.key==='Enter'&&S.secret.length===S.digits)lockSecret();}}),
        h('button',{className:'btn btn-go',style:{marginTop:'16px'},disabled:S.secret.length!==S.digits||S.loading,onClick:lockSecret},
          S.loading?'Locking...':'üîí Lock In Secret'),
        S.err?h('div',{className:'error'},S.err):null)));
    setTimeout(()=>{const i=root.querySelector('.dig-inp');if(i)i.focus();},100);
    return;
  }

  // WAITING FOR OTHER SECRET
  if(S.scr==='waiting_secret'){
    const o=opp();
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'card fade-up',style:{textAlign:'center'}},
        h('div',{style:{fontSize:'36px',marginBottom:'8px'}},'üîí'),
        h('h2',{style:{fontSize:'20px',fontWeight:'800',marginBottom:'8px'}},'Your Secret is Locked!'),
        h('p',{style:{color:'var(--tx2)',fontSize:'14px'}},`Waiting for ${o?.name||'opponent'} to set their number...`),
        h('div',{style:{marginTop:'20px'}},h('div',{className:'pdot'})))));
    return;
  }

  // PLAYING
  if(S.scr==='playing'&&S.G){
    const m=me(), o=opp();
    const mG=getGuesses(m), oG=getGuesses(o);
    const lastO=oG[oG.length-1];
    const needFb=lastO && !lastO.feedback;
    const myT=S.G.currentTurn===S.role;
    const over=S.G.status==='finished';
    const didIWin = S.G.winner === S.role; // winner = the one whose guess was correct

    const lay=h('div',{className:'glayout'});

    // Sticky top: my secret
    lay.appendChild(h('div',{className:'topbar'},
      h('div',{},
        h('div',{className:'my-secret-lbl'},'Your Secret'),
        h('div',{className:'my-secret'},m?.secret||'????')),
      !S.revealed
        ?h('button',{className:'btn btn-sm btn-out',style:{width:'auto'},onClick:doReveal},'üëÅ Reveal')
        :h('span',{style:{fontSize:'12px',color:'var(--ok)',fontWeight:'700'}},'‚úì Revealed to opponent')));

    // Status
    let sc='wait',st=`‚è≥ Waiting for ${o?.name}...`;
    if(over){sc='done';st=didIWin?`üèÜ You cracked it in ${mG.length} guesses!`:`${o?.name} cracked yours in ${oG.length} guesses`;}
    else if(needFb){sc='fb';st=`‚ö° ${o?.name} guessed ‚Äî give feedback!`;}
    else if(myT){sc='go';st='üéØ Your turn ‚Äî make a guess!';}
    lay.appendChild(h('div',{className:`status ${sc}`},st));

    // Tabs
    const t1=h('button',{className:`tab ${S.tab==='my'?'on':''}`,onClick:()=>up({tab:'my'})},`Your Guesses (${mG.length})`);
    const t2=h('button',{className:`tab ${S.tab==='their'?'on':''}`,onClick:()=>up({tab:'their'})},`${o?.name||'Them'} (${oG.length})`);
    if(needFb) t2.appendChild(h('span',{className:'dot'}));
    lay.appendChild(h('div',{className:'tabs'},t1,t2));

    // Content
    const list=h('div',{className:'glist'});
    if(S.tab==='my'){
      if(!mG.length) list.appendChild(h('div',{style:{textAlign:'center',padding:'40px 20px',color:'var(--tx2)',fontSize:'14px'}},
        `No guesses yet ‚Äî you're guessing ${o?.name}'s number`));
      else mG.forEach((g,i)=>list.appendChild(gRow(g,i)));
      if(S.opRev||over) list.appendChild(h('div',{className:'rev-box'},
        h('div',{className:'rev-lbl'},`${o?.name}'s Secret Was`),h('div',{className:'my-secret'},o?.secret||'???')));
    } else {
      if(!oG.length) list.appendChild(h('div',{style:{textAlign:'center',padding:'40px 20px',color:'var(--tx2)',fontSize:'14px'}},
        `${o?.name} hasn't guessed yet`));
      else oG.forEach((g,i)=>list.appendChild(gRow(g,i)));
      if(needFb&&!over) list.appendChild(fbPanel());
    }
    lay.appendChild(list);

    // Action bar
    if(!over){
      if(S.tab==='my'){
        if(myT&&!needFb){
          lay.appendChild(h('div',{className:'actbar'},
            h('div',{className:'ginrow'},
              h('input',{className:'inp dig-inp',type:'tel',maxLength:S.digits,placeholder:'‚Ä¢'.repeat(S.digits),value:S.guess,
                onInput:e=>{const v=e.target.value.replace(/[^0-9]/g,'');if(v.length<=S.digits)up({guess:v,err:''});},
                onKeydown:e=>{if(e.key==='Enter'&&S.guess.length===S.digits)sendGuess();}}),
              h('button',{className:'btn btn-acc',disabled:S.guess.length!==S.digits||S.loading,onClick:sendGuess},
                S.loading?'...':'‚Üí')),
            S.err?h('div',{className:'error'},S.err):null));
        } else if(needFb){
          lay.appendChild(h('div',{className:'actbar'},
            h('div',{style:{textAlign:'center',color:'var(--p2)',fontWeight:'700',fontSize:'14px',cursor:'pointer'},
              onClick:()=>up({tab:'their'})},`‚ö° Tap here to give feedback on ${o?.name}'s guess ‚Üí`)));
        } else {
          lay.appendChild(h('div',{className:'actbar'},
            h('div',{style:{textAlign:'center',color:'var(--tx2)',fontSize:'14px'}},
              `Waiting for ${o?.name} to make a guess...`)));
        }
      }
    } else {
      lay.appendChild(h('div',{className:'actbar'},
        h('button',{className:'btn btn-go',onClick:restart},'üîÑ New Game')));
    }

    root.appendChild(lay);

    // Winner overlay
    if(S.showWin){
      root.appendChild(h('div',{className:'overlay',onClick:()=>up({showWin:false})},
        h('div',{className:'card wcard pop'},
          h('div',{style:{fontSize:'64px',marginBottom:'16px'}},didIWin?'üèÜ':'üòÖ'),
          h('div',{style:{fontSize:'28px',fontWeight:'800',color:didIWin?'var(--ok)':'var(--bad)'}},
            didIWin?'You Won!':'They Got It!'),
          h('div',{style:{color:'var(--tx2)',fontSize:'15px',margin:'8px 0 28px'}},
            didIWin?`You cracked ${o?.name}'s number in ${mG.length} guesses!`
              :`${o?.name} cracked your number in ${oG.length} guesses`),
          h('button',{className:'btn btn-go',onClick:e=>{e.stopPropagation();restart();}},'Play Again'),
          h('button',{className:'btn btn-out',style:{marginTop:'8px'},onClick:e=>{e.stopPropagation();up({showWin:false});}},'View Board'))));
    }

    // Scroll & focus
    const gl=root.querySelector('.glist');
    if(gl)setTimeout(()=>gl.scrollTop=gl.scrollHeight,50);
    if(!over&&myT&&!needFb&&S.tab==='my'){
      const gi=root.querySelector('.actbar .dig-inp');
      if(gi)setTimeout(()=>gi.focus(),150);
    }
  }
}

render();
</script>
</body>
</html>
